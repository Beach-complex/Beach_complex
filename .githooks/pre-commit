#!/bin/sh
set -e

# GUI tools may not inherit PATH; add common Homebrew locations.
export PATH="$PATH:/usr/local/bin:/opt/homebrew/bin"

# Run Spotless auto-formatting (Java)
# - Java 파일이 스테이징된 경우에만 실행한다(문서/설정 변경 커밋 속도 개선).
# - GRADLE_USER_HOME이 없으면 레포 내부로 지정해 훅이 홈 디렉토리에 의존하지 않도록 한다.
STAGED_JAVA_FILE_LIST=$(mktemp)
git diff --cached --name-only --diff-filter=ACMR -- '*.java' > "$STAGED_JAVA_FILE_LIST" 2>/dev/null || true
if [ -s "$STAGED_JAVA_FILE_LIST" ]; then
  if [ -f "./gradlew" ]; then
    if [ -z "${GRADLE_USER_HOME:-}" ]; then
      export GRADLE_USER_HOME="$PWD/.gradle-user-home"
    fi
    ./gradlew spotlessApply --no-daemon
    # Re-stage only files that were already staged Java files before formatting.
    while IFS= read -r file; do
      [ -n "$file" ] && [ -f "$file" ] && git add -- "$file"
    done < "$STAGED_JAVA_FILE_LIST"
  else
    echo "gradlew not found; skipping Spotless."
  fi
else
  echo "No staged Java changes; skipping Spotless."
fi
rm -f "$STAGED_JAVA_FILE_LIST"

# Secret scan on staged changes
if [ -x "./scripts/secret-scan.sh" ]; then
  ./scripts/secret-scan.sh
else
  echo "secret-scan.sh not found; skipping secret scan."
fi
