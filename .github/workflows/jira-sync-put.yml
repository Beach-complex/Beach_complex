name: Update Jira Issue on GitHub Edit

on:
  issues:
    types: [edited]

jobs:
  update-jira:
    runs-on: ubuntu-latest
    # ì œëª©ì— 'PB-'ê°€ í¬í•¨ë˜ì–´ ìˆì„ ë•Œë§Œ ì‹¤í–‰ (ë¬´í•œ ë£¨í”„/ì˜¤ì‘ë™ ë°©ì§€)
    if: contains(github.event.issue.title, 'PB-')

    steps:
      - name: Extract Jira Key
        id: get-key
        run: |
          TITLE="${{ github.event.issue.title }}"
          # ì •ê·œì‹ìœ¼ë¡œ [PB-123] ë˜ëŠ” PB-123 ì¶”ì¶œ
          KEY=$(echo "$TITLE" | grep -o 'PB-[0-9]\+' | head -n 1)
          echo "Jira Key Found: $KEY"
          echo "key=$KEY" >> $GITHUB_OUTPUT

      - name: Update Jira Issue
        uses: actions/github-script@v6
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_KEY: ${{ steps.get-key.outputs.key }}
        with:
          script: |
            const jiraKey = process.env.JIRA_KEY;
            const baseUrl = process.env.JIRA_BASE_URL;
            const email = process.env.JIRA_USER_EMAIL;
            const token = process.env.JIRA_API_TOKEN;

            // ê¹ƒí—ˆë¸Œ ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const ghTitle = context.payload.issue.title;
            const ghBody = context.payload.issue.body || "ë‚´ìš© ì—†ìŒ"; // ë³¸ë¬¸ì´ ë¹„ì—ˆì„ ë•Œ ë°©ì–´
            const ghUrl = context.payload.issue.html_url;

            

            // Jira API v3ìš© ADF(ë¬¸ì„œ í¬ë§·) êµ¬ì¡° ë§Œë“¤ê¸°
            // ê¹ƒí—ˆë¸Œ ë§ˆí¬ë‹¤ìš´ì„ ì–µì§€ë¡œ ë³€í™˜í•˜ì§€ ì•Šê³  'ì½”ë“œ ë¸”ë¡'ì— ë„£ì–´ ì•ˆì „í•˜ê²Œ ì „ì†¡í•©ë‹ˆë‹¤.
            const adfBody = {
              "type": "doc",
              "version": 1,
              "content": [
                {
                  // ê²½ê³ ë¬¸êµ¬ 
                  "type": "paragraph",
                  "content": [
                    {
                      "type": "text",
                      "text": "âš ï¸ GitHubì—ì„œ ë³¸ë¬¸ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. (ì›ë³¸ ë§ˆí¬ë‹¤ìš´):"
                    }
                  ]
                },
                {
                  // ì½”ë“œë¸”ë¡ 
                  "type": "codeBlock",
                  "attrs": { "language": "markdown" },
                  "content": [
                    {
                      "type": "text",
                      "text": ghBody
                    }
                  ]
                },
                {
                  // ë°”ë¡œê°€ê¸° ë§í¬
                  "type": "paragraph",
                  "content": [
                    {
                      "type": "text",
                      "text": "ğŸ”— "
                    },
                    {
                      "type": "text",
                      "text": "GitHub ì´ìŠˆ ë°”ë¡œê°€ê¸°",
                      "marks": [
                        {
                          "type": "link",
                          "attrs": {
                            "href": ghUrl
                          }
                        }
                      ]
                    }
                  ]
                }
              ]
            };

            // Jira API í˜¸ì¶œ (PUT)
            const response = await fetch(`${baseUrl}/rest/api/3/issue/${jiraKey}`, {
              method: 'PUT',
              headers: {
                'Authorization': `Basic ${Buffer.from(`${email}:${token}`).toString('base64')}`,
                'Accept': 'application/json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                fields: {
                  summary: ghTitle,
                  description: adfBody // ìœ„ì—ì„œ ë§Œë“  ADF ê°ì²´ë¥¼ ë„£ìŠµë‹ˆë‹¤.
                }
              })
            });

            if (!response.ok) {
              const errorText = await response.text();
              console.log("Payload:", JSON.stringify(adfBody, null, 2)); // ë””ë²„ê¹…ìš© ë¡œê·¸
              core.setFailed(`Jira API Error: ${response.status} ${errorText}`);
            } else {
              console.log(`Successfully updated Jira issue ${jiraKey} (Title & Body)`);
            }