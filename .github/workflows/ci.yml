name: CI Pipeline

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

  # 수동 실행 버튼 활성화
  workflow_dispatch:

# 중복 실행 방지 그룹 설정
# 동일한 워크플로우와 브랜치에서 새 요청이 오면 기존 실행을 취소함
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backend-build-test:
    name: Backend Build & Test (Unit + Integration)
    runs-on: ubuntu-latest
    env:
      LANG: C.UTF-8
      LC_ALL: C.UTF-8
      JAVA_TOOL_OPTIONS: -Dfile.encoding=UTF-8 -Dsun.jnu.encoding=UTF-8


    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 인코딩 UTF-8 테스트
      - name: Verify UTF-8 encoding for tracked files
        run: |
          python3 scripts/verify-utf8.py

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 최소 정적 테스트
      - name: Static checks (minimal)
        run: ./gradlew compileJava checkstyleMain spotlessCheck --no-daemon --stacktrace

      # 1회 실행으로 통합 + 상세 로그 옵션 추가
      # Testcontainers 통합 테스트 포함
      - name: Build and Test (Unit + Integration + API)
        run: ./gradlew test assemble jacocoTestReport --no-daemon --stacktrace
        env:
          # Testcontainers가 GitHub Actions에서 Docker를 찾을 수 있도록 설정
          TESTCONTAINERS_RYUK_DISABLED: true


      # 테스트 실패 시 리포트 업로드
      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/reports/tests/test/

      # 커버리지 리포트 업로드 (HTML + XML)
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            build/reports/jacoco/test/html/ 
            build/reports/jacoco/test/*.xml 

      # 빌드 성공 시 jar 업로드
      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build/libs/*.jar
